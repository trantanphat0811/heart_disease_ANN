<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch S·ª≠ Ki·ªÉm Tra - D·ª± ƒêo√°n B·ªánh Tim</title>
    <link rel="stylesheet" href="/static/common.css">
    <style>
        .batch-item { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; border-left: 5px solid var(--primary); }
        .batch-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .batch-title { font-size: 1.3em; font-weight: 700; color: var(--primary); }
        .batch-filename { color: #666; font-size: 0.95em; }
        .batch-meta { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px; }
        .meta-item { background: #f5f5f5; padding: 12px; border-radius: 8px; }
        .meta-label { color: #666; font-size: 0.85em; }
        .meta-value { font-size: 1.2em; font-weight: 700; color: #333; margin-top: 5px; }
        .batch-stats { display: flex; gap: 15px; padding-top: 15px; border-top: 2px solid #f0f0f0; }
        .stat-pill { background: #f5f5f5; padding: 10px 20px; border-radius: 20px; font-weight: 600; }
        .stat-pill-high { background: rgba(231, 76, 60, 0.1); color: var(--danger); }
        .stat-pill-low { background: rgba(39, 174, 96, 0.1); color: var(--success); }
        .batch-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
        .patient-row { display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 0.85em; }
        .patient-row:hover { background: #f5f5f5; }
        
        @media (max-width: 768px) {
            .batch-meta { grid-template-columns: repeat(2, 1fr); }
            .batch-actions { flex-direction: column; }
            .btn-sm { width: 100%; }
        }
    </style>
</head>
<body>
    <nav>
        <a href="menu.html" class="logo">
            <div class="logo-icon">‚ù§Ô∏è</div>
            <span>Heart Care</span>
        </a>
        <ul class="nav-links">
            <li><a href="menu.html">üè† Trang Ch·ªß</a></li>
            <li><a href="train.html">üîÆ D·ª± ƒêo√°n</a></li>
            <li><a href="batch_check.html">üìä H√†ng Lo·∫°t</a></li>
            <li><a href="patients.html">üë• B·ªánh Nh√¢n</a></li>
        </ul>
    </nav>

    <div class="container">
        <header>
            <h1>üìú L·ªãch S·ª≠ Ki·ªÉm Tra</h1>
            <p class="subtitle">C√°c l·∫ßn t·∫£i l√™n v√† x·ª≠ l√Ω d·ªØ li·ªáu b·ªánh nh√¢n h√†ng lo·∫°t</p>
        </header>

        <!-- Statistics -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalBatches">0</div>
                <div class="stat-label">T·ªïng L·∫ßn Ki·ªÉm Tra</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalPatients">0</div>
                <div class="stat-label">T·ªïng B·ªánh Nh√¢n</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalHighRisk">0</div>
                <div class="stat-label">Nguy C∆° Cao</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgRiskScore">0%</div>
                <div class="stat-label">Trung B√¨nh Nguy C∆°</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-success" onclick="exportHistory()">üì• Xu·∫•t L·ªãch S·ª≠</button>
            <button class="btn btn-danger" onclick="deleteHistoryConfirm()">üóëÔ∏è X√≥a T·∫•t C·∫£ L·ªãch S·ª≠</button>
        </div>

        <!-- Batch History -->
        <div id="historyContainer"></div>
    </div>

    <!-- Batch Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Chi Ti·∫øt Ki·ªÉm Tra</h2>
                <button class="close-btn" onclick="closeDetailModal()">√ó</button>
            </div>
            <div id="detailContent" style="max-height: 60vh; overflow-y: auto;"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeDetailModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script src="/static/js/patient-data.js"></script>
    <script>
        function loadHistory() {
            console.log('üìú [history.html] loadHistory called');
            console.log('üëâ [history.html] PatientDataManager type:', typeof PatientDataManager);
            
            if (typeof PatientDataManager === 'undefined') {
                console.error('‚ùå [history.html] PatientDataManager NOT available!');
                alert('‚ùå L·ªói: PatientDataManager ch∆∞a load. Vui l√≤ng reload trang.');
                return;
            }
            
            const history = PatientDataManager.getBatchHistory();
            console.log('‚úÖ [history.html] Loaded', history.length, 'batches');
            const container = document.getElementById('historyContainer');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div class="empty-text">Ch∆∞a c√≥ l·ªãch s·ª≠ ki·ªÉm tra</div>
                        <p style="color: #999;">B·∫Øt ƒë·∫ßu b·∫±ng c√°ch <a href="batch_check.html" style="color: var(--primary); font-weight: 700;">t·∫£i l√™n file CSV</a></p>
                    </div>
                `;
                updateStatistics();
                return;
            }

            container.innerHTML = '';
            
            history.forEach((batch, idx) => {
                const uploadDate = new Date(batch.uploadDate);
                const highPercent = batch.totalPatients > 0 ? Math.round((batch.stats.totalHigh / batch.totalPatients) * 100) : 0;
                
                const batchHTML = document.createElement('div');
                batchHTML.className = 'batch-item';
                batchHTML.innerHTML = `
                    <div class="batch-header">
                        <div>
                            <div class="batch-title">#${history.length - idx}: ${batch.filename}</div>
                            <div class="batch-filename">Ng√†y t·∫£i: ${uploadDate.toLocaleString('vi-VN')}</div>
                        </div>
                    </div>
                    
                    <div class="batch-meta">
                        <div class="meta-item">
                            <div class="meta-label">T·ªïng B·ªánh Nh√¢n</div>
                            <div class="meta-value">${batch.totalPatients}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Nguy C∆° Cao</div>
                            <div class="meta-value" style="color: var(--danger);">${batch.stats.totalHigh}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Nguy C∆° Th·∫•p</div>
                            <div class="meta-value" style="color: var(--success);">${batch.stats.totalLow}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">T·ª∑ L·ªá Cao</div>
                            <div class="meta-value">${highPercent}%</div>
                        </div>
                    </div>
                    
                    <div class="batch-stats">
                        <span class="stat-pill stat-pill-high">‚¨ÜÔ∏è ${batch.stats.totalHigh} Cao</span>
                        <span class="stat-pill stat-pill-low">‚¨áÔ∏è ${batch.stats.totalLow} Th·∫•p</span>
                    </div>
                    
                    <div class="batch-actions">
                        <button class="btn-sm btn-view" onclick="showBatchDetails('${batch.id}')">üëÅÔ∏è Xem Chi Ti·∫øt</button>
                        <button class="btn-sm btn-export" onclick="exportBatch('${batch.id}')">üì• Xu·∫•t CSV</button>
                        <button class="btn-sm btn-delete" onclick="deleteBatch('${batch.id}')">üóëÔ∏è X√≥a</button>
                    </div>
                `;
                
                container.appendChild(batchHTML);
            });

            updateStatistics();
        }

        function showBatchDetails(batchId) {
            const batch = PatientDataManager.getBatchHistory().find(b => b.id === batchId);
            if (!batch) return;

            const detailContent = document.getElementById('detailContent');
            const modalTitle = document.getElementById('modalTitle');
            
            modalTitle.textContent = `Chi Ti·∫øt Ki·ªÉm Tra: ${batch.filename}`;
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px; color: var(--primary);">üìä T·ªïng Quan</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="background: #f5f5f5; padding: 10px; border-radius: 6px;">
                            <div style="color: #666; font-size: 0.85em;">T·ªïng B·ªánh Nh√¢n</div>
                            <div style="font-size: 1.3em; font-weight: 700; color: var(--primary);">${batch.totalPatients}</div>
                        </div>
                        <div style="background: #f5f5f5; padding: 10px; border-radius: 6px;">
                            <div style="color: #666; font-size: 0.85em;">Ng√†y T·∫£i</div>
                            <div style="font-size: 1.1em; font-weight: 700;">${new Date(batch.uploadDate).toLocaleString('vi-VN')}</div>
                        </div>
                        <div style="background: rgba(231, 76, 60, 0.1); padding: 10px; border-radius: 6px;">
                            <div style="color: #666; font-size: 0.85em;">Nguy C∆° Cao</div>
                            <div style="font-size: 1.3em; font-weight: 700; color: var(--danger);">${batch.stats.totalHigh}</div>
                        </div>
                        <div style="background: rgba(39, 174, 96, 0.1); padding: 10px; border-radius: 6px;">
                            <div style="color: #666; font-size: 0.85em;">Nguy C∆° Th·∫•p</div>
                            <div style="font-size: 1.3em; font-weight: 700; color: var(--success);">${batch.stats.totalLow}</div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 style="margin-bottom: 10px; color: var(--primary);">üë• Danh S√°ch B·ªánh Nh√¢n</h3>
                    <div class="patient-row" style="font-weight: 700; background: #f0f0f0;">
                        <div>#</div>
                        <div>Tu·ªïi</div>
                        <div>Gi·ªõi T√≠nh</div>
                        <div>BMI</div>
                        <div>BP</div>
                        <div>Nh·ªãp Tim</div>
                        <div>Nguy C∆°</div>
                        <div>M·ª©c ƒê·ªô</div>
                    </div>
            `;

            batch.patients.forEach((patient, idx) => {
                const riskPercent = (patient.risk_score * 100).toFixed(1);
                const riskLevel = patient.label === 'Cao' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                html += `
                    <div class="patient-row">
                        <div>${idx + 1}</div>
                        <div>${patient.Age}</div>
                        <div>${patient.Gender}</div>
                        <div>${patient.BMI?.toFixed(1)}</div>
                        <div>${patient.Systolic_BP}/${patient.Diastolic_BP}</div>
                        <div>${patient.Heart_Rate}</div>
                        <div>${riskPercent}%</div>
                        <div>${riskLevel} ${patient.label}</div>
                    </div>
                `;
            });

            html += '</div>';
            detailContent.innerHTML = html;
            
            document.getElementById('detailModal').classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function exportBatch(batchId) {
            if (PatientDataManager.exportBatchToCSV(batchId)) {
                alert('‚úÖ Xu·∫•t batch th√†nh c√¥ng');
            } else {
                alert('‚ùå L·ªói khi xu·∫•t batch');
            }
        }

        function deleteBatch(batchId) {
            if (confirm('‚ö†Ô∏è X√°c nh·∫≠n x√≥a ki·ªÉm tra n√†y v√† t·∫•t c·∫£ b·ªánh nh√¢n trong ƒë√≥?')) {
                if (PatientDataManager.deleteBatch(batchId)) {
                    loadHistory();
                    alert('‚úÖ ƒê√£ x√≥a ki·ªÉm tra');
                }
            }
        }

        function deleteHistoryConfirm() {
            if (confirm('‚ö†Ô∏è X√ÅC NH·∫¨N x√≥a TO√ÄN B·ªò l·ªãch s·ª≠? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                if (PatientDataManager.clearAllData()) {
                    loadHistory();
                }
            }
        }

        function exportHistory() {
            if (PatientDataManager.exportAllDataAsJSON()) {
                alert('‚úÖ Xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng');
            } else {
                alert('‚ùå L·ªói khi xu·∫•t d·ªØ li·ªáu');
            }
        }

        function updateStatistics() {
            const stats = PatientDataManager.getStatistics();
            document.getElementById('totalBatches').textContent = stats.totalBatches;
            document.getElementById('totalPatients').textContent = stats.totalPatients;
            document.getElementById('totalHighRisk').textContent = stats.highRisk;
            document.getElementById('avgRiskScore').textContent = stats.averageRiskScore + '%';
        }

        // Load on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadHistory, 100);
            
            // Listen for data updates from other tabs
            try {
                const channel = new BroadcastChannel('patient_data_updates');
                channel.onmessage = (event) => {
                    if (event.data.type === 'data-updated') {
                        console.log('üì° [history.html] Received data update from batch_check:', event.data);
                        // Auto-reload history
                        setTimeout(loadHistory, 200);
                    }
                };
                console.log('‚úÖ [history.html] Listening for broadcast updates');
            } catch (error) {
                console.warn('‚ö†Ô∏è [history.html] BroadcastChannel not available:', error);
            }
        });
    </script>
</body>
</html>
