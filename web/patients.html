<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω B·ªánh Nh√¢n - D·ª± ƒêo√°n B·ªánh Tim</title>
    <link rel="stylesheet" href="/static/common.css">
    <style>
        .action-cell { display: flex; gap: 8px; }
    </style>
</head>
<body>
    <nav>
        <a href="menu.html" class="logo">
            <div class="logo-icon">‚ù§Ô∏è</div>
            <span>Heart Care</span>
        </a>
        <ul class="nav-links">
            <li><a href="menu.html">üè† Trang Ch·ªß</a></li>
            <li><a href="train.html">üîÆ D·ª± ƒêo√°n</a></li>
            <li><a href="batch_check.html">üìä H√†ng Lo·∫°t</a></li>
            <li><a href="history.html">üìú L·ªãch S·ª≠</a></li>
        </ul>
    </nav>

    <div class="container">
        <header>
            <h1>üë• Qu·∫£n L√Ω B·ªánh Nh√¢n</h1>
            <p class="subtitle">Danh s√°ch t·∫•t c·∫£ b·ªánh nh√¢n ƒë∆∞·ª£c d·ª± ƒëo√°n t·ª´ c√°c l·∫ßn ki·ªÉm tra h√†ng lo·∫°t</p>
        </header>

        <!-- Statistics -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalPatients">0</div>
                <div class="stat-label">T·ªïng B·ªánh Nh√¢n</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="highRiskCount">0</div>
                <div class="stat-label">Nguy C∆° Cao</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lowRiskCount">0</div>
                <div class="stat-label">Nguy C∆° Th·∫•p</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="highRiskPercent">0%</div>
                <div class="stat-label">T·ª∑ L·ªá Cao</div>
            </div>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm theo tu·ªïi, gi·ªõi t√≠nh, BMI, huy·∫øt √°p...">
                <button class="search-btn" onclick="performSearch()">T√¨m Ki·∫øm</button>
                <button class="search-btn" onclick="clearSearch()" style="background: #666;">X√≥a</button>
            </div>
            <button class="btn btn-success" onclick="exportPatients()">üì• Xu·∫•t CSV</button>
            <button class="btn btn-danger" onclick="deleteAllConfirm()">üóëÔ∏è X√≥a T·∫•t C·∫£</button>
        </div>

        <!-- Patients Table -->
        <div class="table-section">
            <div id="emptyState" class="empty-state">
                <div class="empty-icon">üë§</div>
                <div class="empty-text">Ch∆∞a c√≥ d·ªØ li·ªáu b·ªánh nh√¢n</div>
                <p style="color: #999;">T·∫£i l√™n file CSV t·ª´ trang <a href="batch_check.html" style="color: var(--primary); font-weight: 700;">ki·ªÉm tra h√†ng lo·∫°t</a></p>
            </div>
            
            <div id="tableContainer" style="display: none;">
                <div class="table-wrapper">
                    <table id="patientsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Tu·ªïi</th>
                                <th>Gi·ªõi T√≠nh</th>
                                <th>BMI</th>
                                <th>Huy·∫øt √Åp (mmHg)</th>
                                <th>Nh·ªãp Tim</th>
                                <th>Cholesterol</th>
                                <th>Nguy C∆° (%)</th>
                                <th>M·ª©c ƒê·ªô</th>
                                <th>H√†nh ƒê·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="patientsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Chi Ti·∫øt B·ªánh Nh√¢n</div>
                <button class="close-btn" onclick="closeDetailModal()">‚úï</button>
            </div>
            <div id="detailContent"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeDetailModal()">ƒê√≥ng</button>
                <button class="btn btn-danger" onclick="deleteCurrentPatient()">X√≥a B·ªánh Nh√¢n</button>
            </div>
        </div>
    </div>

    <script src="/static/js/patient-data.js"></script>
    <script>
        let allPatients = [];
        let currentPatientId = null;

        function loadPatients() {
            console.log('üìã [patients.html] loadPatients called');
            console.log('üëâ [patients.html] PatientDataManager type:', typeof PatientDataManager);
            
            if (typeof PatientDataManager === 'undefined') {
                console.error('‚ùå [patients.html] PatientDataManager NOT available!');
                alert('‚ùå L·ªói: PatientDataManager ch∆∞a load. Vui l√≤ng reload trang.');
                return;
            }
            
            allPatients = PatientDataManager.getAllPatients();
            console.log('‚úÖ [patients.html] Loaded', allPatients.length, 'patients:', allPatients);
            displayPatients(allPatients);
            updateStatistics();
        }

        function displayPatients(patients) {
            console.log('üìä [patients.html] displayPatients called with', patients.length, 'patients');
            const tbody = document.getElementById('patientsBody');
            const tableContainer = document.getElementById('tableContainer');
            const emptyState = document.getElementById('emptyState');

            tbody.innerHTML = '';

            if (patients.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';

            patients.forEach((patient, idx) => {
                const riskPercent = (patient.risk_score * 100).toFixed(1);
                const riskBadge = patient.label === 'Cao' 
                    ? `<span class="badge badge-high">‚¨ÜÔ∏è ${patient.label}</span>`
                    : `<span class="badge badge-low">‚¨áÔ∏è ${patient.label}</span>`;

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${idx + 1}</td>
                    <td>${patient.Age || '-'}</td>
                    <td>${patient.Gender || '-'}</td>
                    <td>${patient.BMI?.toFixed(1) || '-'}</td>
                    <td>${patient.Systolic_BP}/${patient.Diastolic_BP}</td>
                    <td>${patient.Heart_Rate || '-'}</td>
                    <td>${patient.Cholesterol_Total || '-'}</td>
                    <td>${riskPercent}</td>
                    <td>${riskBadge}</td>
                    <td>
                        <div class="action-cell">
                            <button class="btn-sm btn-info" onclick="showDetails('${patient.patientId}')">üëÅÔ∏è Xem</button>
                            <button class="btn-sm btn-delete" onclick="deletePatient('${patient.patientId}')">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
            });
        }

        function updateStatistics() {
            const stats = PatientDataManager.getStatistics();
            document.getElementById('totalPatients').textContent = stats.totalPatients;
            document.getElementById('highRiskCount').textContent = stats.highRisk;
            document.getElementById('lowRiskCount').textContent = stats.lowRisk;
            document.getElementById('highRiskPercent').textContent = stats.highRiskPercent + '%';
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                loadPatients();
                return;
            }

            const results = PatientDataManager.searchPatients(query);
            displayPatients(results);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            loadPatients();
        }

        function showDetails(patientId) {
            currentPatientId = patientId;
            const patient = PatientDataManager.getPatientById(patientId);
            if (!patient) return;

            const riskPercent = (patient.risk_score * 100).toFixed(1);
            const bpColor = patient.Systolic_BP > 140 || patient.Diastolic_BP > 90 ? 'style="color: var(--danger);"' : '';

            const detailContent = document.getElementById('detailContent');
            detailContent.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Tu·ªïi</div>
                        <div class="detail-value">${patient.Age}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Gi·ªõi T√≠nh</div>
                        <div class="detail-value">${patient.Gender}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Chi·ªÅu Cao (cm)</div>
                        <div class="detail-value">${patient.Height}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">C√¢n N·∫∑ng (kg)</div>
                        <div class="detail-value">${patient.Weight}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">BMI</div>
                        <div class="detail-value">${patient.BMI?.toFixed(1)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">H√∫t Thu·ªëc</div>
                        <div class="detail-value">${patient.Smoking}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">R∆∞·ª£u Bia</div>
                        <div class="detail-value">${patient.Alcohol_Intake}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Ho·∫°t ƒê·ªông Th·ªÉ Ch·∫•t</div>
                        <div class="detail-value">${patient.Physical_Activity}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Ch·∫ø ƒê·ªô ƒÇn</div>
                        <div class="detail-value">${patient.Diet}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">M·ª©c ƒê·ªô CƒÉng Th·∫≥ng</div>
                        <div class="detail-value">${patient.Stress_Level}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">TƒÉng Huy·∫øt √Åp</div>
                        <div class="detail-value">${patient.Hypertension ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Ti·ªÉu ƒê∆∞·ªùng</div>
                        <div class="detail-value">${patient.Diabetes ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">M·ª° M√°u Cao</div>
                        <div class="detail-value">${patient.Hyperlipidemia ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Ti·ªÅn S·ª≠ B·ªánh Tim</div>
                        <div class="detail-value">${patient.Family_History ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">T·ª´ng Nh·ªìi Tim</div>
                        <div class="detail-value">${patient.Previous_Heart_Attack ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Huy·∫øt √Åp T√¢m Thu (mmHg)</div>
                        <div class="detail-value" ${bpColor}>${patient.Systolic_BP}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Huy·∫øt √Åp T√¢m Tr∆∞∆°ng (mmHg)</div>
                        <div class="detail-value" ${bpColor}>${patient.Diastolic_BP}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Nh·ªãp Tim (nh·ªãp/ph√∫t)</div>
                        <div class="detail-value">${patient.Heart_Rate}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ƒê∆∞·ªùng Huy·∫øt L√∫c Nh·ªãn (mg/dL)</div>
                        <div class="detail-value">${patient.Blood_Sugar_Fasting}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Cholesterol To√†n Ph·∫ßn (mg/dL)</div>
                        <div class="detail-value">${patient.Cholesterol_Total}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Nguy C∆° B·ªánh Tim</div>
                        <div class="detail-value">${riskPercent}%</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">K·∫øt Lu·∫≠n</div>
                        <div class="detail-value" style="color: ${patient.label === 'Cao' ? 'var(--danger)' : 'var(--success)'};">
                            ${patient.label === 'Cao' ? '‚¨ÜÔ∏è Nguy C∆° Cao' : '‚¨áÔ∏è Nguy C∆° Th·∫•p'}
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Ng√†y D·ª± ƒêo√°n</div>
                        <div class="detail-value">${new Date(patient.prediction_date).toLocaleString('vi-VN')}</div>
                    </div>
                </div>
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
            currentPatientId = null;
        }

        function deletePatient(patientId) {
            if (confirm('‚ö†Ô∏è X√°c nh·∫≠n x√≥a b·ªánh nh√¢n n√†y?')) {
                if (PatientDataManager.deletePatient(patientId)) {
                    loadPatients();
                    alert('‚úÖ ƒê√£ x√≥a b·ªánh nh√¢n');
                }
            }
        }

        function deleteCurrentPatient() {
            if (currentPatientId) {
                closeDetailModal();
                deletePatient(currentPatientId);
            }
        }

        function deleteAllConfirm() {
            if (confirm('‚ö†Ô∏è X√ÅC NH·∫¨N x√≥a TO√ÄN B·ªò b·ªánh nh√¢n? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                if (PatientDataManager.clearAllData()) {
                    loadPatients();
                }
            }
        }

        function exportPatients() {
            if (PatientDataManager.exportPatientsToCSV()) {
                alert('‚úÖ Xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng');
            } else {
                alert('‚ùå L·ªói khi xu·∫•t d·ªØ li·ªáu');
            }
        }

        // Load on page load with delay to ensure PatientDataManager is available
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadPatients, 100);
            
            // Listen for data updates from other tabs
            try {
                const channel = new BroadcastChannel('patient_data_updates');
                channel.onmessage = (event) => {
                    if (event.data.type === 'data-updated') {
                        console.log('üì° [patients.html] Received data update from batch_check:', event.data);
                        // Auto-reload patients list
                        setTimeout(loadPatients, 200);
                    }
                };
                console.log('‚úÖ [patients.html] Listening for broadcast updates');
            } catch (error) {
                console.warn('‚ö†Ô∏è [patients.html] BroadcastChannel not available:', error);
            }
        });
    </script>
</body>
</html>
